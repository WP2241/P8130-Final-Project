---
title: "FinalProject"
author: "Hyewon Choi"
date: "12/8/2017"
output: html_document
---

#Loading the data, observing duplicates
```{r load libraries & data}
library(readr)
library(readxl)
library(janitor)
library(tidyverse)
library(pander)
library(leaps)
library(HH)
library(boot)


hos = read_excel("./data/GHProject_Dataset.xlsx")

duplicates = data.frame(table(hos$PatientID)) 

duplicates = duplicates[duplicates$Freq > 1,] %>%
  rename(PatientID = Var1)
#69 patients visited the hospital more than once, 68 visited twice and 1 visited three times

hos_duplicates = merge(duplicates, hos)
```

#Tidying the data
```{r tidy data}
hos_tidy <- hos %>% 
  clean_names() %>%
  select(-loshours, -postalcode, -facilityname, -facilityzip) %>%
  group_by(patientid) %>% 
  filter(!duplicated(patientid)) %>%
  ungroup(patientid)
```

#Summary Statistics
```{r summary statistics}
summary_losdays2 = hos_tidy %>% 
  select(losdays2) %>%
  summarize(variable = names(.), 
            n = n(), mean = mean(losdays2), 
            sd = sd(losdays2), 
            minimum = min(losdays2), 
            maximum = max(losdays2), 
            median = median(losdays2))

summary_ageyear = hos_tidy %>% 
  select(ageyear) %>%
  summarize(variable = names(.), n = n(), 
            mean = mean(ageyear),
            sd = sd(ageyear),
            minimum = min(ageyear),
            maximum = max(ageyear),
            median = median(ageyear))

summary_evisit = hos_tidy %>% 
  select(evisit) %>%
  summarize(variable = names(.),
            n = n(),
            mean = mean(evisit),
            sd = sd(evisit),
            minimum = min(evisit),
            maximum = max(evisit),
            median = median(evisit))

summary = rbind(summary_losdays2, summary_ageyear, summary_evisit)
pander(summary)
```

#Data observations & building dummies
```{r observing data & building dummies}
hos_tidy %>%
  ggplot(aes(x = losdays2)) + 
    geom_histogram() +
    labs(title = "Figure 1: Length of Stay",
         x = "Length of Stay (Days)",
         y = "Count")
  

```

```{r omit na}
fill_na = function(x) {
  if (is.numeric(x)){
   mean = mean(x, na.rm = TRUE)
   x = replace(x, is.na(x), mean)
  } else {x = x} 
    
  return(x)
}

hos_tidy_omitna = map_df(hos_tidy, fill_na)


```

  
### Stepwise selection
```{r Stepwise selection}
hos_tidy_omitna = hos_tidy_omitna %>%
  mutate(log_losdays2 = log(losdays2)) %>%
  na.omit()
mult.fit <- lm(log_losdays2 ~ is30dayreadmit + ageyear + evisit+ cindex + maritalstatus + insurancetype + race + respirationrate + o2sat + heartrate + bmi + temperature + bpsystolic + bpdiastolic + mews + icu_flag, data = hos_tidy_omitna) 
summary(mult.fit)

z = step(mult.fit, direction = 'both') 
summary(z)

#mews score based on bp, respiration, heartrate & temp and is a less significant variable than bp, resp $ temp 
#the two bp readings are correlated
#of all the dummy variables, only insurancetype was significant

```

### Criterion-based procedures
```{r criterion}
mult.fit <- lm(log_losdays2 ~ is30dayreadmit + evisit+ cindex + ageyear + maritalstatus + insurancetype + race + respirationrate + o2sat + heartrate + bmi + temperature + bpsystolic + bpdiastolic + mews + icu_flag, data = hos_tidy_omitna) 

best <- function(model, ...) 
{
  subsets <- regsubsets(formula(model), model.frame(model), ...)
  subsets <- with(summary(subsets),
                  cbind(p = as.numeric(rownames(which)), which, rss, rsq, adjr2, cp, bic))
  
  return(subsets)
}  

best(mult.fit, nbest = 1)
```

#Final model
```{r}
mult.fit2 <- lm(log_losdays2 ~ is30dayreadmit + evisit+ cindex + ageyear +  respirationrate + heartrate  + bpsystolic, data = hos_tidy_omitna) 

best(mult.fit2, nbest = 1)

vif(mult.fit2)
```

#Checking outliers
```{r}
# # Simple linear regression
# reg_hos<-lm(hos_tidy_omitna$log_losdays2~hos_tidy_omitna$is30dayreadmit)


stu_res<-rstandard(mult.fit2)
outliers_y<-stu_res[abs(stu_res)>2.5]

#removing outliers
hos_tidy_omitna_outl <- hos_tidy_omitna[c(-6,-232,-277,-326,-370,-412,-514,-533,-559,-603,-628,-703,-770,-800,-821,-835,-850,-861,-878,-984,-1118,-1341,-1398,-1477,-1497, -1523,-1610,-1645,-1704,-1885,-2002,-2070,-2153,-2395,-2462,-2529,-2557,-2776,-2793,-2834,-2859,-2932,-3078,-3091,-3109,-3110, -3121, -3136, -3180, -3306, -3307, -3327, -3338, -3341, -3414),]

influence.measures(mult.fit2)

```

#Vif
```{r}
library(HH)
vif(mult.fit2)
```

#Building the model without the outliers
```{r}
mult.fit3 <- lm(log_losdays2 ~ is30dayreadmit + evisit+ cindex + ageyear +  respirationrate + heartrate  + bpsystolic, data = hos_tidy_omitna_outl) 

best(mult.fit3, nbest = 1)
summary(mult.fit3)
```

#Bootstrap
```{r}
set.seed(1)


boot.fn<-function(data, index){
	return(coef(lm(log_losdays2 ~ is30dayreadmit + evisit+ cindex + ageyear +  respirationrate + heartrate  + bpsystolic, data = hos_tidy_omitna, subset=index)))
}
boot.fn(hos_tidy_omitna,1:3502)


set.seed(1)


boot.fn(hos_tidy_omitna,sample(3502,3502,replace=T))



boot(hos_tidy_omitna, boot.fn, 1000)

# How does it compare to the original (non-bootstrap) estimates?
summary(mult.fit2)
```




#Residuals
```{r}
par(mfrow=c(2,2))
plot(mult.fit2)
```
