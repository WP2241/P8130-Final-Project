---
title: "FinalProject"
author: "Hyewon Choi"
date: "12/8/2017"
output: html_document
---

#Loading the data, observing duplicates
```{r load libraries & data}
library(readr)
library(readxl)
library(janitor)
library(tidyverse)
library(pander)
library(leaps)

hos = read_excel("./data/GHProject_Dataset.xlsx")

duplicates = data.frame(table(hos$PatientID)) 

duplicates = duplicates[duplicates$Freq > 1,] %>%
  rename(PatientID = Var1)
#69 patients visited the hospital more than once, 68 visited twice and 1 visited three times

hos_duplicates = merge(duplicates, hos)
```

#Tidying the data
```{r tidy data}
hos_tidy <- hos %>% 
  clean_names() %>%
  select(-loshours, -postalcode, -facilityname, -facilityzip) %>%
  group_by(patientid) %>% 
  filter(!duplicated(patientid)) %>%
  ungroup(patientid)
```

#Summary Statistics
```{r summary statistics}
summary_losdays2 = hos_tidy %>% 
  select(losdays2) %>%
  summarize(variable = names(.), 
            n = n(), mean = mean(losdays2), 
            sd = sd(losdays2), 
            minimum = min(losdays2), 
            maximum = max(losdays2), 
            median = median(losdays2))

summary_ageyear = hos_tidy %>% 
  select(ageyear) %>%
  summarize(variable = names(.), n = n(), 
            mean = mean(ageyear),
            sd = sd(ageyear),
            minimum = min(ageyear),
            maximum = max(ageyear),
            median = median(ageyear))

summary_evisit = hos_tidy %>% 
  select(evisit) %>%
  summarize(variable = names(.),
            n = n(),
            mean = mean(evisit),
            sd = sd(evisit),
            minimum = min(evisit),
            maximum = max(evisit),
            median = median(evisit))

summary = rbind(summary_losdays2, summary_ageyear, summary_evisit)
pander(summary)
```

#Data observations & building dummies
```{r observing data & building dummies}
hos_tidy %>%
  ggplot(aes(x = losdays2)) + 
    geom_histogram() +
    labs(title = "Figure 1: Length of Stay",
         x = "Length of Stay (Days)",
         y = "Count")
  
hos_tidy$gender = ifelse(hos_tidy$gender == "Male", 1, ifelse(hos_tidy$gender == "Female", 0, NA))

hos_dummies = hos_tidy %>%
  mutate(white = ifelse(race == "White", "1", "0"),
         black = ifelse(race == "African Amer/Black", "1", "0"),
         asian = ifelse(race == "Asian", "1", "0"),
         natv_amer_alaskan = ifelse(race == "Native Amer/Alaskan", "1", "0"),
         natv_hawaii_pacf_isl = ifelse(race == "Natv Hawaii/Pacf Isl", "1", "0"))
### "Others" is (0,0,0,0,0)
### "White" is (1,0,0,0,0)
### "Black" is (0,1,0,0,0)
### "Asian" is (0,0,1,0,0)
### "Native Amer/Alaskan" is (0,0,0,1,0)
### "Natv Hawaii/Pacf Isl" is (0,0,0,0,1)


hos_dummies = hos_dummies %>%
  mutate(medicare = ifelse(insurancetype == "Medicare", "1", "0"),
         medicaid = ifelse(insurancetype == "Medicaid", "1", "0"),
         private = ifelse(insurancetype == "Private", "1", "0"))
### "NA" is (0,0,0)
### "Medicare" is (1,0,0)
### "Medicaid" is (0,1,0)
### "Private" is (0,0,1)


hos_dummies = hos_dummies %>%
  mutate(single = ifelse(maritalstatus == "Single", "1", "0"),
         married = ifelse(maritalstatus == "Married", "1", "0"),
         widowed = ifelse(maritalstatus == "Widowed", "1", "0"),
         divorced = ifelse(maritalstatus == "Divorced", "1", "0"),
         separated = ifelse(maritalstatus == "Separated", "1", "0"),
         civil_union = ifelse(maritalstatus == "Civil Union", "1", "0"))
### "NA" is (0,0,0,0,0,0)
### "single" is (1,0,0,0,0,0)
### "married" is (0,1,0,0,0,0)
### "widowed" is (0,0,1,0,0,0)
### "divorced" is (0,0,0,1,0,0)
### "separated" is (0,0,0,0,1,0)
### "civil_union" is (0,0,0,0,0,1)


hos_dummies = hos_dummies %>%
  mutate(log_losdays2 = log(losdays2)) %>%
  select(-race, -insurancetype, -maritalstatus)
```

```{r omit na}
fill_na = function(x) {
  if (is.numeric(x)){
   mean = mean(x, na.rm = TRUE)
   x = replace(x, is.na(x), mean)
  } else {x = x} 
    
  return(x)
}

hos_tidy_omitna = map_df(hos_tidy, fill_na)


```

  
### Stepwise selection
```{r Stepwise selection}
hos_tidy_omitna = hos_tidy_omitna %>%
  mutate(log_losdays2 = log(losdays2)) %>%
  na.omit()
mult.fit <- lm(log_losdays2 ~ is30dayreadmit + ageyear + evisit+ cindex + maritalstatus + insurancetype + race + respirationrate + o2sat + heartrate + bmi + temperature + bpsystolic + bpdiastolic, data = hos_tidy_omitna) 

step(mult.fit, direction = 'both') 

```

```{r}
mult.fit <- lm(log_losdays2 ~ is30dayreadmit + cindex + mews + evisit + icu_flag + ageyear + gender + single + married + widowed + divorced + separated + civil_union + medicare + medicaid + private + white + black + asian + natv_amer_alaskan + natv_hawaii_pacf_isl + respirationrate + o2sat + heartrate + bmi + temperature + bpsystolic + bpdiastolic, data = hos_dummies) 

z = step(mult.fit, direction = "both")
summary(z)

#mews score based on bp, respiration, heartrate & temp and is a less significant variable than bp, resp $ temp 
#the two bp readings are correlated, diastolic is more significant
#of all the dummy variables, only insurancetype was significant

```

### Criterion-based procedures
```{r criterion}
mult.fit <- lm(log_losdays2 ~ is30dayreadmit + evisit+ cindex + ageyear + maritalstatus + insurancetype + race + respirationrate + o2sat + heartrate + bmi + temperature + bpsystolic + bpdiastolic, data = hos_tidy_omitna) 

best <- function(model, ...) 
{
  subsets <- regsubsets(formula(model), model.frame(model), ...)
  subsets <- with(summary(subsets),
                  cbind(p = as.numeric(rownames(which)), which, rss, rsq, adjr2, cp, bic))
  
  return(subsets)
}  

best(mult.fit, nbest = 1)
```

